# Coverage Improvement Plan - 2026.01.02

## Objective
Increase code coverage from <40% to >98% by refactoring the codebase for testability and eliminating code duplication between production logic and test logic.

## Stages

### Stage 1: Refactor Utilities and Deduplication
**Goal:** Centralize logic for file extension checking and formatting, and add missing unit tests.
1.  **Promote `allowed_exts`:** Move the list of allowed extensions to a `const` or static slice in the main module.
2.  **Promote `is_source_file`:** Move this helper function from the `tests` module to the main module and make it public/visible. Update `main` to use it.
3.  **Test Utilities:** Add unit tests for `format_size` and `format_filename`.

### Stage 2: Refactor and Test Directory Processing
**Goal:** Test the actual directory processing logic used in production.
1.  **Extract Function:** Extract the directory walking and processing logic from `main` into a new function:
    ```rust
    fn process_directory(path: &Path, output: &mut File) -> Result<(u64, u64), Box<dyn std::error::Error>>
    ```
2.  **Update Main:** Call this new function in `main`.
3.  **Update Tests:** Rewrite `test_process_directory` to call this new function instead of duplicating the logic.

### Stage 3: Refactor and Test ZIP Processing
**Goal:** Test the actual ZIP processing logic used in production.
1.  **Extract Function:** Extract the ZIP processing logic from `main` into a new function:
    ```rust
    fn process_zip(path: &Path, output: &mut File) -> Result<(u64, u64), Box<dyn std::error::Error>>
    ```
2.  **Update Main:** Call this new function in `main`.
3.  **Update Tests:** Rewrite `test_process_zip` to call this new function.

### Stage 4: High-Level Integration
**Goal:** Ensure the entry point logic is covered as much as possible.
1.  **Extract `run`:** Move the core logic (after argument parsing) into a `run` function that accepts the input path.
2.  **Integration Test:** Create a test that calls `run` (or the separated processing functions) to simulate a full execution flow.

## Verification
After each stage, `cargo llvm-cov` will be run to verify the coverage increase and ensure no regressions.
